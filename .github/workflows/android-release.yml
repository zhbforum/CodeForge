name: Android APK Release

on:
  push:
    tags:
      - 'mobile-v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android-release:
    name: Build & upload Android APKs to Release
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: apps/mobile_app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.4"
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get --enforce-lockfile

      - name: Verify launcher images
        shell: bash
        run: |
          shopt -s nullglob
          files=(android/app/src/main/res/mipmap-*/ic_launcher_*.png)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No launcher images found â€” check paths."
            exit 1
          fi
          for f in "${files[@]}"; do
            if head -c 25 "$f" | tr -d '\0' | grep -qa '^version https://git-lfs'; then
              echo "LFS POINTER detected: $f"
              exit 1
            fi
            sig=$(xxd -p -l 12 "$f" 2>/dev/null || echo "")
            if [[ "$sig" == 89504e470d0a1a0a* ]]; then
              echo "OK PNG:  $f"
            elif [[ "$sig" == ffd8ff* ]]; then
              echo "OK JPEG: $f"
            elif [[ "$sig" == 52494646* ]] && head -c 12 "$f" | strings | grep -qa 'WEBP'; then
              echo "OK WEBP: $f"
            else
              echo "Unknown/invalid image header: $f (sig=$sig)"
              exit 1
            fi
          done
          echo "All launcher images look valid."

      - name: Generate code
        run: dart run build_runner build -d

      - name: Build release APK (per-ABI)
        run: flutter build apk --release --split-per-abi

      - name: List built APKs
        run: ls -R build/app/outputs || true

      - name: Upload APKs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/*-release.apk

      - name: Upload APKs to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            apps/mobile_app/build/app/outputs/flutter-apk/*-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
