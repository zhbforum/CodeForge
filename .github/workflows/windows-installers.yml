name: Windows installers (MSIX + Inno Installer)

on:
  push:
    tags:
      - 'mobile-v*'   
  workflow_dispatch:   

jobs:
  build-windows-installers:
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'

      - name: Flutter pub get
        working-directory: apps/mobile_app
        run: flutter pub get

      - name: Restore signing certificate (PFX)
        working-directory: apps/mobile_app
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.CODEFORGE_MSIX_PFX }}")
          New-Item -ItemType Directory -Force -Path "windows/certs" | Out-Null
          [IO.File]::WriteAllBytes("windows/certs/codeforge_dev.pfx", $bytes)

      - name: Build MSIX
        working-directory: apps/mobile_app
        run: |
          dart run msix:create --certificate-password="${{ secrets.CODEFORGE_MSIX_PWD }}"

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Build Inno Setup installer (.exe)
        working-directory: apps/mobile_app
        run: |
          ISCC.exe tools\codeforge_installer.iss

      - name: Upload installers as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: codeforge-windows-installers
          path: |
            apps/mobile_app/build/windows/x64/runner/Release/CodeForge.msix
            apps/mobile_app/dist/windows-installer/CodeForge-Setup.exe

      - name: Upload installers to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            apps/mobile_app/build/windows/x64/runner/Release/CodeForge.msix
            apps/mobile_app/dist/windows-installer/CodeForge-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
