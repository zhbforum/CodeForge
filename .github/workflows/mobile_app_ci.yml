name: CodeForge CI

on:
  push:
    paths:
      - "apps/mobile_app/**"
      - ".github/workflows/mobile_app_ci.yml"
  pull_request:
    paths:
      - "apps/mobile_app/**"
      - ".github/workflows/mobile_app_ci.yml"

permissions:
  contents: read

concurrency:
  group: mobile-app-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format_analyze_test:
    name: Format • Analyze • Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: apps/mobile_app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.4"
          cache: true
      - name: Flutter version
        run: flutter --version
      - name: Install dependencies
        run: flutter pub get --enforce-lockfile
      - name: Verify launcher images
        shell: bash
        run: |
          shopt -s nullglob
          files=(android/app/src/main/res/mipmap-*/ic_launcher_*.png)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No launcher images found — check paths."
            exit 1
          fi
          for f in "${files[@]}"; do
            if head -c 25 "$f" | tr -d '\0' | grep -qa '^version https://git-lfs'; then
              echo "LFS POINTER detected: $f"
              exit 1
            fi
            sig=$(xxd -p -l 12 "$f" 2>/dev/null || echo "")
            if [[ "$sig" == 89504e470d0a1a0a* ]]; then
              echo "OK PNG:  $f"
            elif [[ "$sig" == ffd8ff* ]]; then
              echo "OK JPEG: $f"
            elif [[ "$sig" == 52494646* ]] && head -c 12 "$f" | strings | grep -qa 'WEBP'; then
              echo "OK WEBP: $f"
            else
              echo "Unknown/invalid image header: $f (sig=$sig)"
              exit 1
            fi
          done
          echo "All launcher images look valid."
      - name: Generate code
        run: dart run build_runner build -d
      - name: Check formatting
        shell: bash
        run: |
          set -e
          FILES=$(git ls-files '*.dart' ':!**/*.g.dart' ':!**/*.freezed.dart' ':!**/*.gen.dart' ':!**/generated/**')
          if [ -n "$FILES" ]; then
            dart format --output=none --set-exit-if-changed $FILES
          else
            echo "No non-generated Dart files to check."
          fi
      - name: Analyze
        run: flutter analyze --no-pub --fatal-warnings
      - name: Ensure no uncommitted changes after generation
        shell: bash
        run: |
          git update-index -q --refresh || true
          CHANGED=$(git diff --name-only -- . \
            ':(exclude)**/*.g.dart' \
            ':(exclude)**/*.freezed.dart' \
            ':(exclude)**/*.gen.dart' \
            ':(exclude)**/generated/**')
          if [ -n "$CHANGED" ]; then
            echo "Non-generated files changed after codegen/format:"
            echo "$CHANGED"
            exit 1
          fi
          echo "OK: only generated files differ (or none)."
      - name: Run tests
        run: flutter test --coverage
      - name: Enforce coverage threshold
        shell: bash
        run: |
          LCOV=coverage/lcov.info
          if [ ! -f "$LCOV" ]; then
            echo "Coverage file not found: $LCOV"
            exit 1
          fi
          total=$(grep -o "LF:[0-9]\+" "$LCOV" | awk -F: '{s+=$2} END{print s+0}')
          hit=$(grep -o "LH:[0-9]\+" "$LCOV" | awk -F: '{s+=$2} END{print s+0}')
          if [ "$total" -gt 0 ]; then
            pct=$(awk -v h="$hit" -v t="$total" 'BEGIN{printf("%.2f", (h*100)/t)}')
          else
            pct=0
          fi
          echo "Coverage: ${pct}%  (Lines: ${hit}/${total})"
          awk -v p="$pct" -v th=75 'BEGIN{ exit (p+0<th) ? 1 : 0 }'
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  build_android:
    name: Build Android APK (main & tags)
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: apps/mobile_app
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.4"
          cache: true
      - name: Flutter doctor
        run: flutter doctor -v
      - name: Install dependencies
        run: flutter pub get --enforce-lockfile
      - name: Verify launcher images
        shell: bash
        run: |
          shopt -s nullglob
          files=(android/app/src/main/res/mipmap-*/ic_launcher_*.png)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No launcher images found — check paths."
            exit 1
          fi
          for f in "${files[@]}"; do
            if head -c 25 "$f" | tr -d '\0' | grep -qa '^version https://git-lfs'; then
              echo "LFS POINTER detected: $f"
              exit 1
            fi
            sig=$(xxd -p -l 12 "$f" 2>/dev/null || echo "")
            if [[ "$sig" == 89504e470d0a1a0a* ]]; then
              echo "OK PNG:  $f"
            elif [[ "$sig" == ffd8ff* ]]; then
              echo "OK JPEG: $f"
            elif [[ "$sig" == 52494646* ]] && head -c 12 "$f" | strings | grep -qa 'WEBP'; then
              echo "OK WEBP: $f"
            else
              echo "Unknown/invalid image header: $f (sig=$sig)"
              exit 1
            fi
          done
          echo "All launcher images look valid."
      - name: Generate code
        run: dart run build_runner build -d
      - name: Build release APK (per-ABI)
        run: flutter build apk --release --split-per-abi
      - name: Locate APK(s)
        id: locate_apk
        shell: bash
        run: |
          ROOT="build/app/outputs"
          ls -R "$ROOT" || true
          files=()
          while IFS= read -r -d '' f; do files+=("$f"); done < <(find "$ROOT" -type f -name "*.apk" -print0)
          if [ ${#files[@]} -eq 0 ]; then
            echo "paths=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          printf 'paths<<EOF\n%s\nEOF\n' "$(printf "%s\n" "${files[@]}")" >> "$GITHUB_OUTPUT"
      - name: Upload APK artifact(s)
        if: ${{ steps.locate_apk.outputs.paths != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-apk

  deploy_web:
    name: Deploy Flutter Web to GitHub Pages
    needs: format_analyze_test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.4"
          cache: true

      - name: Enable web
        run: flutter config --enable-web

      - name: Build & deploy to GitHub Pages
        uses: bluefireteam/flutter-gh-pages@v9
        with:
          workingDir: apps/mobile_app
          baseHref: /CodeForge/
          token: ${{ secrets.GITHUB_TOKEN }}
